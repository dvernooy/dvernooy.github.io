<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.8.0 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->


<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Heart Rate Monitor - Ab hinc</title>




<meta name="description" content="Still working after all these years">




<meta name="author" content="Dave Vernooy">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Ab hinc">
<meta property="og:title" content="Heart Rate Monitor">


  <link rel="canonical" href="http://localhost:4000/projects/HRM/">
  <meta property="og:url" content="http://localhost:4000/projects/HRM/">



  <meta property="og:description" content="Still working after all these years">

















  

  



  <meta property="og:image" content="http://localhost:4000/assets/images/front/site-logo.png">



  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2018-01-21T20:16:29-05:00">






  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000",
      "logo": "http://localhost:4000/assets/images/front/site-logo.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Dave Vernooy",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>







<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Ab hinc Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->





    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
  </head>


  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">Ab hinc</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/projects/" >Projects</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/blog/" >Blog</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about/" >About</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        
        <a href="https://dvernooy.github.io">
          <img src="http://localhost:4000/assets/images/front/dave-vernooy-cropped.jpg" alt="Dave Vernooy" itemprop="image">
        </a>
      
    </div>
  

  <div class="author__content">
    
      <a href="https://dvernooy.github.io"><h3 class="author__name" itemprop="name">Dave Vernooy</h3></a>
    
    
      <p class="author__bio" itemprop="description">
        Learning by (re)doing
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Niskayuna, NY</span>
        </li>
      

      
        <li>
          <a href="https://dvernooy.github.io" itemprop="url">
            <i class="fa fa-fw fa-chain" aria-hidden="true"></i> Website
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/dvernooy" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Heart Rate Monitor">
    <meta itemprop="description" content="Still working after all these years">
    <meta itemprop="datePublished" content="January 21, 2018">
    <meta itemprop="dateModified" content="April 12, 2013">

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Heart Rate Monitor
</h1>
          <h4 class="page__related-title">Still working after all these years</h4> 
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  17 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#project-overview">Project overview</a></li>
  <li><a href="#stem">S.T.E.M.</a>
    <ul>
      <li><a href="#polar-t6-talk-to-me">Polar T6, talk to me</a></li>
      <li><a href="#resonant-magnetic-coupling">Resonant magnetic coupling</a></li>
      <li><a href="#inductors">Inductors</a></li>
    </ul>
  </li>
  <li><a href="#hardware">Hardware</a>
    <ul>
      <li><a href="#main-inductor-sensor">Main inductor sensor</a></li>
      <li><a href="#analog-receiver--overall-circuit-diagram">Analog receiver &amp; overall circuit diagram</a></li>
      <li><a href="#nokia-2115i-lcd">Nokia 2115i LCD</a></li>
      <li><a href="#supporting-character-set">Supporting character set</a></li>
      <li><a href="#microcontroller">Microcontroller</a></li>
      <li><a href="#packaging">Packaging</a></li>
    </ul>
  </li>
  <li><a href="#software">Software</a>
    <ul>
      <li><a href="#code">Code</a></li>
      <li><a href="#detecting-a-beat">Detecting a beat</a></li>
      <li><a href="#tricky-bits">Tricky bits</a></li>
      <li><a href="#-heart-rate-following-algorithm">… Heart rate following algorithm</a></li>
      <li><a href="#learning-by-re-doing">Learning by re-doing</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<p><img src="http://localhost:4000/assets/images/projects/HRM/screenshot.png" alt="" />
<em>MacGyver, eat your heart out</em></p>

<h2 id="project-overview">Project overview</h2>
<p>Welcome to my heart rate monitor project. These things have been around for a long time &amp; you can buy them now for about $15 bundled with all kinds of software. So if you want to start measuring your heart rate, stop reading this, go buy one and have fun! Otherwise, stay tuned for all of the trials and tribulations of DIY’ing a heart rate monitor.</p>

<p>It started as a shotgun marriage between a dead Nokia 2115i cellphone and a chest strap for an old Polar T6 heart rate monitor - both of which were lying around. What better way to kill a couple of Saturdays then try to build my own receiver using the LCD out of the cell phone? Little did I know the long &amp; winding road. If you’re still with me, you’ll know that navigating that road is where the real fun is!!!</p>

<p>The end result was not super pretty looking, but it was such a fun project I thought I’d take you through it in detail. If you’re already laughing at me for doing this (i.e., hey, dude, Polar has been making these things since the early ’80s, where have you been &amp; by the way, ever heard of Fitbit?), you’ll laugh harder when you see the pictures of the receiver attached to my bike with some modified pvc tubing:</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/bike_view.png" alt="" />
<em>Nothing unusual to see here, move along</em></p>

<p>Here are a couple of charts of my heart rate vs. time for a 1.5 hour bike ride near my house, along with a screenshot of the elevation changes - pretty good correlation between the two. I used to be a decent hill climber.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/correlation.png" alt="" />
<em>Pretty good match between hills &amp; workout. Duh, whaddya expect?</em></p>

<p>And here is the average of a few rides on one of my usual 1.5 hr routes. I did a bit of stitching to account for a flat tire pit stop on one of the rides. Not sure its particularly interesting for any given year, but it will be interesting to look at how it changes over 5 or 10 yrs.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/aggregate.png" alt="" />
<em>Pretty consistent ride-to-ride</em></p>

<p>So here we go. Time for some fun.</p>

<h2 id="stem">S.T.E.M.</h2>
<p>Here’s how I built up my understanding, piece by piece.</p>

<h3 id="polar-t6-talk-to-me">Polar T6, talk to me</h3>
<p>I had no idea what the old Polar T6 transmitter did or how it worked, so I opened it up - I don’t have an actual picture of the inside handy, but this “x-ray” picture (the second image of the two below) that I found on the web is pretty similar to what I saw inside. The key feature here is that inductor/coil on the bottom, and more specifically the magnetic field pattern that it creates (dashed lines):</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/transmitter.png" alt="" />
<em>Heart rate monitor transmitter</em></p>

<p>I was armed with background knowledge that many of these older transmitters work at 5.3 kHz. So, I did a couple of experiments after I had changed out the battery and made some modifications to the chest strap, which was in rough shape.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/strap.jpg" alt="" />
<em>Oh yeah, and this new chest strap looks so awesome</em></p>

<p>The first step was to directly wire this other old coil I had lying around into my oscilloscope:</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/coil-sniff.jpg" alt="" />
<em>The coil I used to understand the transmitter</em></p>

<p>I held this second coil over top of the transmitter piece as it was attached to my chest. Here is what I saw on the scope:</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/zoom0.jpg" alt="" />
<em>My heart be still! I’m alive!</em></p>

<p>Heartbeats! … spaced about 1 second apart. Here’s what the waveform looked like on successively zooming in from 100 ms to 5 ms to 1 ms to 100 <script type="math/tex">\mu</script>s (you can see the time scales on the scope images):</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/scope_shots.png" alt="" />
<em>Successive zoom-ins on the oscilloscope while using the coil to see what the transmitter was doing</em></p>

<p>Interesting, it has some significant structure to it. Overall time of the heartbeat signal is about 8 ms, with the main bursts at 5.3 kHz interrupted by much shorter bursts at about 300 kHz. It might be coded or something. Wanting to move forward, I decided just to build a 5.3 kHz receiver &amp; not worry about understanding the coding, because if I could reliably detect those 5.3 kHz bursts, I’d have my heart rate. So how do you detect a 5.3 kHz electrical signal?</p>

<h3 id="resonant-magnetic-coupling">Resonant magnetic coupling</h3>

<p>A couple of things I noticed in my experiments:</p>
<blockquote>
  <p>As I moved the inductor even a few inches away, the signal faded … a sign of non-resonant coupling.</p>
</blockquote>

<blockquote>
  <p>As I rotated the inductor 90 degrees, it was pretty easy to kill the signal altogether … a clue that the (electro)magnetic field orientation was important.</p>
</blockquote>

<p>Well, the current the transmitter drives through its inductor creates a time-varying magnetic field. If I could interrupt those magnetic field lines with another inductor (just like I did in my experiment), I can detect that burst.</p>

<p>But, just one more thing - I want it to work a few meters away. The only way to do that was to “tune” the receiver circuit to the exact transmitter frequency of 5.3 kHz, while keeping the inductor <script type="math/tex">L</script> as large as practically possible. The way to do this is with an <script type="math/tex">LC</script> tank circuit, whose resonant frequency is</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}
& f = \frac{1}{2 \pi \sqrt{LC}}
\end{align*} %]]></script>

<h3 id="inductors">Inductors</h3>
<p>The formula for inductance of a wound coil is:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}
 & L = \frac{\mu N^2 A}{l}
\end{align*} %]]></script>

<p>where <script type="math/tex">N</script> is the number of turns, <script type="math/tex">A</script> is the area, <script type="math/tex">l</script> is the length and <script type="math/tex">\mu</script> is the relative permeability. So the number of turns are a big deal. Enough already. Time to build some hardware.</p>

<h2 id="hardware">Hardware</h2>

<h3 id="main-inductor-sensor">Main inductor sensor</h3>
<p>I had a ferrite core about an inch long, with a permeability multiplier of about 16, which meant for 1000 turns of coil I should expect 24 mH. The one I built measured 19 mH, which required a 47 nF capacitor to resonate at 5.3 kHz. I used the frequency sweep on my benchtop function generator to do fine tuning to 5.3 kHz using trial and error on the capacitance. Putting the two in parallel, I could now sense the signal from more than a meter away, which was a very good start! Time to build the rest of the receiver.</p>

<h3 id="analog-receiver--overall-circuit-diagram">Analog receiver &amp; overall circuit diagram</h3>
<p>Here is the circuit I built-</p>

<p><a href="http://localhost:4000/assets/images/projects/HRM/HRM_circuit.png"><img src="http://localhost:4000/assets/images/projects/HRM/HRM_circuit.png" alt="" /></a>
<em>Circuit diagram for heart rate monitor</em></p>

<p>I have a note scribbled that Rick Moll(?) had a receiver very similar to this posted, but I can’t find that link anymore. If I do, I’ll put it here.</p>

<p>The main idea is to amplify &amp; filter the ac signal with two op-amp stages, followed by peak detection and a level-shifting buffer prior to the microcontroller ADC input. I used a quad LM324, taking one of them to create a virtual ground of 2.4V (assuming Vcc of 4.8V from 3 AA’s) to shift up the AC signal .. which is required with a single-supply design like this. You also need to AC couple between stages to avoid amplifying the DC.</p>

<p>I know there are many things I could improve, but this project was not about style, which is actually my style. I didn’t spend any time laying out a board, but did it all “dead bug” on a  piece of copper clad board. Not pretty, but fast to build and it works well.</p>

<p>If I get time, I’ll add a few images of the analog part of the circuit and receiver waveform output, but now I had something a digital circuit could deal with.</p>

<h3 id="nokia-2115i-lcd">Nokia 2115i LCD</h3>
<p>After a huge amount of googling, I found out that the Nokia 2115i’s mono LCD had the same pinout as those in the 1100/1200/1600. It had a special Hirose DF23-10 connector that I needed an adapter for</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/lcd_pinout.png" alt="" />
<em>Pinout for the LCD. Essential to avoiding smoke</em></p>

<p>and, most importantly, I found out it used the Philips PCF8814 96x65 pixel LCD driver. The spec sheet for this driver was indispensable - I was able to use it to bit-bang the SPI interface. The spec is posted with the code.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/PCF8814.png" alt="" />
<em>pages 26-29 of PCF8814 spec were dog-eared by the end of this project</em></p>

<h3 id="supporting-character-set">Supporting character set</h3>
<p>I used a spreadsheet to build my own character bitmap set for the LCD, along with a few custom “graphics” … a bike and a heart that you can see on the LCD. I’ve also included this spreadsheet with the code.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/icon_bitmap.png" alt="" />
<em>From raw material to finished product: WYSIWYG</em></p>

<h3 id="microcontroller">Microcontroller</h3>
<p>And the rest of the circuit is based on the Atmel ATmega88 microcontroller. I used the built-in an 8MHz clock and a couple of AA batteries (3.2V) to power the digital part separately from the analog. I also included the ability for remote programming via an SPI header. All of the details are in the circuit diagram above.</p>

<p>There are a bunch of things I learned building this:</p>
<blockquote>
  <p>Filter the reset pin with 10K and 10nF when enabling ISP programming</p>
</blockquote>

<blockquote>
  <p>There are many ways to reference the ADC voltage … pick one and go with it</p>
</blockquote>

<blockquote>
  <p>Make sure the fuse settings enable the EEPROM to be saved during reboots &amp; write the software so you can read it out</p>
</blockquote>

<h3 id="packaging">Packaging</h3>
<p>Look away. Now. If you are still looking, here is a picture:</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/circuit_build.png" alt="" />
<em>Ummm. Yeah. Alrighty then.</em></p>

<p>This kind of style is usually actually ok for analog/low noise stuff as long as wires and leads are kept very short. Not so great for debugging &amp; finding issues. The other thing I did is just made a “snap connect” so it easily attaches to the stem of my bike … just a piece of modified pvc with inlaid rubber for grip:</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/attach_mechanism.png" alt="" />
<em>Snap-on connector</em></p>

<h2 id="software">Software</h2>
<h3 id="code">Code</h3>
<p>All the code is posted <a href="https://www.github.com/dvernooy/heart_rate_monitor/">here</a>. It is actually just one C file. You can call it ugly (it is), you can call it unreadable (it is) &amp; I know there are a bunch of typos in the comments which I’ll try to fix up at some point. But it works, &amp; very robustly. If you actually do read it, all the action is in a single main() loop. Here is my thought process …</p>

<h3 id="detecting-a-beat">Detecting a beat</h3>
<p>My starting point now was the analog signal (masquerading basically as a digital signal at this point due to the speed and gain of my receiver) that rose and saturated very quickly when a 5.3 kHz burst was detected. The saturated voltage is about 4.7V at the upper rail of the last stage op-amp (I used a 5V regulated supply for the analog portion). I fed this waveform into the analog-to-digital converter of the Atmega88 and compared it to a software threshold that I set to determine whether it was a real heart beat signal.</p>

<p>To measure the timing between heartbeats, I had a choice of whether to do an interrupt driven timing scheme, or a polling-based scheme. I opted for polling simply because I was really early in understanding how all of this was going to work and I found it to be the most flexible way of dealing with the tricky bits (below) that arose. In hindsight, it would be fun to convert to an interrupt-driven approach.</p>

<p>Every time through the master polling loop (more details and a diagram just below), I took an analog-to-digital converter (ADC) measurement and compared it to a threshold value. If it was above the threshold, I had a hit.</p>

<p>In order to turn this into a time measurement, and eventually a beats-per-minute (bpm) rate, I used the polling loop counter <script type="math/tex">H</script>. I calibrated the loop time off-line by feeding my software a fake heartbeat signal from a function generator that simulated a range of heartbeats from 30 bpm to 200 bpm with a square wave of variable duty cycle. I used this to do timing measurements to figure out the calibration constant corresponding to one pass through the loop. The polling loop was 1.61 ms long, so it would be 1245 polling loops between heartbeats for a heart rate of 30bpm and ~ 185 polling loops between heartbeats for 200 bpm. If you read the code, that is where the factor 37312 comes from … it would be 37312 loops through the code every second.</p>

<p>So how did I get such a long polling loop time? And, more importantly, since the loop time acts basically as a master timer, how to make it repeatable from loop to loop? More on this later.</p>

<p>For now, here is a little video of everything put together, demonstrating the stand-off detectability of the receiver, and the importance of keeping the transmitter and receiver coils roughly aligned. You can see that as I rotate my body with the chest strap relative to the receiver, the signal loses lock.</p>

<!-- Courtesy of embedresponsively.com //-->
<div class="responsive-video-container">

  <iframe src="https://www.youtube.com/embed/NeRcglIzrSE" frameborder="0" allowfullscreen=""></iframe>

</div>

<h3 id="tricky-bits">Tricky bits</h3>

<p>There were actually a number of practical issues to deal with to make this thing robust. I’ll explain how I dealt with them one by one, but it is probably best to start with a timing diagram/sketch.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/timing.png" alt="" />
<em>Details about how the code is structured to be robust</em></p>

<blockquote>
  <p>Make sure I didn’t get “double counts” from the heartbeat waveform, which as we already saw is very “bursty”</p>
</blockquote>

<p>I used a dead zone of <script type="math/tex">M</script> polling loop counts long right after the first detection instant. A choice of <script type="math/tex">M</script> around 40 was a good compromise because 40*1.6 = 64 ms is much longer than the 8 ms heartrate burst (so it would’t trigger multiple times on clutter) but much shorter than the ~ 300 ms between beats at 200 bpm. This meant the software would ignore any subsequent ADC hits for the next <script type="math/tex">M</script> polling loops. I used a counter <script type="math/tex">G</script> to countdown from <script type="math/tex">M</script> to zero. Ultimately, made the length of the dead zone dynamic (i.e., heart rate dependent) since I wanted to ensure no false triggers at low heart rate.</p>

<blockquote>
  <p>Make sure an appropriate threshold was set to know that I had a real heartbeat</p>
</blockquote>

<p>I kept track of highest ADC value we got the last time through the loop (remember, it is measured every polling loop) and right before the dead zone ends (<script type="math/tex">G = 1</script>) and we’re ready to start detecting again, I reset the threshold to half of that value. Basically makes the assumption that heartbeat to heartbeat the environment isn’t changing much.</p>

<blockquote>
  <p>Handle a “loss of lock” on the heart rate &amp; recover it</p>
</blockquote>

<p>Ok, so I’m riding on my regular route on a bike path and I notice a drop-out at one particular place. Here is a google map view .. do you see the issue?</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/power_lines.png" alt="" />
<em>Not a friend, an enEMI</em></p>

<p>Yeah, overhead or underground power lines, especially those running somewhat parallel to my route, carry a current that generates a magnetic field that induces more currents in my receiver that swamp the receiver. Even though its not resonant, it causes large enough noise to wreak havoc. So how to recover the heartbeat in a case like this, especially in an extreme case where my heartbeat changes alot during this interval?</p>

<p>I set an absolute lower limit on the detector threshold so as not to trigger on noise, but if the heartbeat loop counter <script type="math/tex">H</script> exceeded a maximum determined by the previous heartbeat interval, I start to allow the detection threshold to drop, &amp; I continue aggressively dropping the detection threshold until it reaches a pre-determined lower limit. This allows the system to re-lock. I also use the same pre-determined lower limit to establish initial lock &amp; the re-set the baseline after the first few beats.</p>

<blockquote>
  <p>Give myself a visual indication that all of this was working</p>
</blockquote>

<p>I decided that a beating heart (what else!) and the heart rate number in a huge font were the way to go. So I designed that heart icon and had it display for half of the heart rate interval. However, <em>every time</em> through <em>the software polling loop</em> I wrote both the heart rate number and either the heart icon or a blank signal icon. This way, the same amount of delay was introduced for each loop. In fact, the time to write these things was by far the dominant delay in the loop and accounted for the 1.61 ms polling loop time. So taking care to make them the same loop-to-loop was important. Again, maybe a reason to go to an interrupt method in the future.</p>

<blockquote>
  <p>Capture the heart rate information so I could look at it after the exercise period</p>
</blockquote>

<p>Funny enough, I did implement an interrupt-driven procedure for probably the <em>least</em> critical thing - saving the heart rate to the EEPROM. Yes, I’m often backwards. Anyways, the ATmega88 only has 500 bytes of EEPROM available. So, I sampled the heart rate every 3 seconds, averaged 4 of these samples, and then every 12 seconds (every 4th sample) wrote the average as one byte (0..255) to the EEPROM. This lets me exercise for 100 minutes and capture my heart rate that whole time. I just read the whole thing out at the end over the SPI interface and plot it in a spreadsheet.</p>

<p>A nit point, but because of the way I wired things up, I made sure the EEPROM is not initialized in the code until a first heartbeat is detected. That way, to read out the EEPROM after exercising I just read it out over the SPI/ISP interface with both switches open (using the ISP’s VCC line to power it up) and without any chest strap.</p>

<blockquote>
  <p>Make sure everything worked for the dynamic range of heart rates from 30 bpm to 200 bpm</p>
</blockquote>

<p>I used my offline signal generator to test out the algorithm across this large range. That worked well, rather than me having to work up a sweat every time I tweaked something in the code.</p>

<blockquote>
  <p>Make sure that as my heart rate changed during exercise, the monitor could follow it robustly</p>
</blockquote>

<p>This last question requires its own section …</p>

<h3 id="-heart-rate-following-algorithm">… Heart rate following algorithm</h3>
<p>One of the more interesting challenges was to figure out how to follow changes in heart rate in a robust way that had a good user experience. I noticed my heartbeat could jump by ~ 20 beats per minute in only a few seconds when exercising and I’d want my sensor to follow this reasonably well. So here’s what I did. I first decided that, independent of what my current heart rate was, I wanted the monitor to settle within 5% of the new heart rate in about 8 seconds. Somewhat arbitrary, but it seemed reasonable for any application I had in mind.</p>

<p>So, each new measurement gave me a new instantaneous heart rate interval (called <script type="math/tex">J</script> in the code). So I wanted to update the current heart rate <script type="math/tex">K</script> to follow the new heart rate <script type="math/tex">J</script>. The error at any point in time is <script type="math/tex">e = J-K</script> and at every heartbeat we need to update <script type="math/tex">K</script> by adding to it a certain percentage <script type="math/tex">f</script> of this error. If you do it all at once (set <script type="math/tex">K = J</script>), the display bounces around &amp; drives you crazy. If you add too little, its like you have an unresponsive monitor.</p>

<p>So how much to add? Well, I knew I wanted to close the gap to within 5% in 8 seconds. So the number of heartbeat intervals required is <script type="math/tex">8K/60</script>. The factor 60 converts beats-per-min to beats-per-second. At each new measurement, we want to update <script type="math/tex">K</script> so</p>

<script type="math/tex; mode=display">\begin{align*}
K_1 = K_0+fe = K_0+f(J-K_0)
\end{align*}</script>

<p>and the gap to <script type="math/tex">J</script> after 1 heartbeat interval is</p>

<script type="math/tex; mode=display">\begin{align*}
J-K_1 = (1-f)(J-K_0)
\end{align*}</script>

<p>After 2 heartbeats the update is</p>

<script type="math/tex; mode=display">\begin{align*}
K_2 = K_1+f(J-K_1) = K_0 + 2f(J-K_0)-f^2(J-K)
\end{align*}</script>

<p>so the gap to <script type="math/tex">J</script> is</p>

<script type="math/tex; mode=display">\begin{align*}
J-K_2 =(1-f)^2(J-K_0)
\end{align*}</script>

<p>You can see where this is headed. After the 8 seconds, or the <script type="math/tex">n = 8K/60</script> heart beats, the gap is <script type="math/tex">(1-f)^n(J-K_0)</script>. But I wanted this to be 5%. So we get the equation that <script type="math/tex">(1-f)^{\frac{8K}{60}}=0.05</script> and we can solve this for</p>

<script type="math/tex; mode=display">\begin{align*}
 f = 1-e^{\frac{60\ln(0.05)}{8K}}
\end{align*}</script>

<p>which gives us the update factor <script type="math/tex">f</script> to use at every single step, given <script type="math/tex">K</script>. Finally, we can put it all together: with every heartbeat we measure a new value for <script type="math/tex">J</script> and we know <script type="math/tex">K</script> from the previous step … so we can apply the update rule:</p>

<script type="math/tex; mode=display">\begin{align*}
K = K +f(J-K)= K + (1-e^{\frac{60\ln(0.05)}{8K}})(J-K)
\tag{1}
\label{master}
\end{align*}</script>

<p>Below is a screenshot of a numerical model of how this algorithm settles.</p>

<p><img src="http://localhost:4000/assets/images/projects/HRM/simulation.png" alt="" />
<em>Following the telltale heart</em></p>

<p>Wheew .. long explanation for something that ends up only being a few lines of code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ADJUST HB with a partial step to current value
</span><span class="k">if</span> <span class="p">((</span><span class="n">J</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="n">K</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">J</span><span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">K</span><span class="p">)){</span>
  <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">exp</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">tolerance</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">seconds_to_lock</span><span class="o">*</span><span class="n">Keff</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span> <span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">coeff</span> <span class="o">&gt;</span> <span class="n">attack_max</span><span class="p">)</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">attack_max</span> <span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="n">coeff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">K</span> <span class="o">&gt;</span> <span class="n">J</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">-</span> <span class="n">coeff</span><span class="o">*</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="n">J</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">K</span> <span class="o">&lt;</span> <span class="n">J</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">coeff</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="n">K</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This algorithm in equation <script type="math/tex">\eqref{master}</script> guarantees a nice display that follows the heartbeat changes in a sensible way. There is one hill around our house where I can go from 130 bpm to 185 bpm in about 15 seconds - &amp; my monitor follows it well. The only technical issue in implementation is that I had to use real precision math, but that could always be changed to integer math at some point.</p>

<h3 id="learning-by-re-doing">Learning by re-doing</h3>
<p>I am thinking about making major changes - learn by (re)doing &amp; all that - to the packaging (no room for improvement there) &amp; code (who needs a menu) at some point … or maybe I’ll buy a fitbit. It has 10X the functionality at 1/10th the hassle. All of the code &amp; spreadsheets are posted.  <a href="https://www.github.com/dvernooy/heart_rate_monitor/">here</a>. Enjoy.</p>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2013-04-12">April 12, 2013</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Heart+Rate+Monitor%20http%3A%2F%2Flocalhost%3A4000%2Fprojects%2FHRM%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fprojects%2FHRM%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fprojects%2FHRM%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fprojects%2FHRM%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/projects/mp3/" class="pagination--pager" title="MP3 4me
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
      <!-- <script src="http://localhost:4000/assets/js/comments.js"></script> -->
      <!-- <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a Comment</h4>
      <section id="disqus_thread"></section>
    
</div> -->
    <div id="disqus_thread"></div>
    <a href="single.html#disqus_thread" data-disqus-identifier=""></a>

    <script>
      // var disqus_developer = 1;
      var disqus_config = function () {
      this.page.url = "/projects/HRM/";
      this.page.identifier = "/projects/HRM/";
      };

      (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://dvernooy-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <script id="dsq-count-scr" src="//dvernooy-github-io.disqus.com/count.js" async></script>
    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
  <input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  <div id="results" class="results"></div>
</div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="https://github.com/dvernooy"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Dave Vernooy. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>



  <script src="http://localhost:4000/assets/js/lunr.min.js"></script>
  <script src="http://localhost:4000/assets/js/lunr-en.js"></script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/projects/HRM/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/projects/06-heart_rate"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://dvernooy.github.io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>